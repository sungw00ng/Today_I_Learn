# 공유자원과 경쟁상태 그리고 임계영역
## 공유자원(shared resource)
- 각 프로세스나 스레드가 함께 접근 가능한 자원이나 변수

## 경쟁 상태(race condition)
- 둘 이상의 프로세스 또는 스레드가 동시에 읽거나 쓰는 상황

## 임계 영역(critical section)
- 둘 이상의 프로세스 또는 스레드가 공유자원에 접근할 때 순서 등의 이유로 결과가 달라지는 코드 영역
- 이 영역은 한 번에 둘 이상의 프로세스나 스레드가 들어갈 수 없게 설계된다.

<br><br>

#### 임계 영역 의사 코드
```text
do {
    lock();
    { 임계 영역 }
    unlock();
}
```

<br><br>

#### JSON
```json
{"num":1000}
```

<br><br>

#### JAVA 예제(2번사용)
```java
import java.io.*;
import java.nio.channels.FileChannel;
import java.nio.channels.FileLock;
import java.nio.file.*;
import org.json.JSONObject;

public class FileUpdater {

    private static final String FILE_PATH = "a.json";

    public static void main(String[] args) {
        Path path = Paths.get(FILE_PATH);

        // Lock 시도
        try (RandomAccessFile file = new RandomAccessFile(FILE_PATH, "rw");
             FileChannel channel = file.getChannel()) {

            // 파일 락 걸기 (blocking)
            System.out.println("Trying to acquire lock...");
            FileLock lock = channel.lock();  // blocking until lock is acquired
            System.out.println("Lock acquired!");

            try {
                // 임계 영역 시작
                String content = new String(Files.readAllBytes(path));
                JSONObject json = new JSONObject(content);
                int num = json.getInt("num");
                json.put("num", num - 1000);

                // 3초 대기
                Thread.sleep(3000);

                // 파일에 다시 저장
                Files.write(path, json.toString().getBytes());
                System.out.println("Updated num to: " + (num - 1000));
                // 임계 영역 끝
            } finally {
                // 락 해제
                lock.release();
                System.out.println("Lock released.");
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

<br><br>

## 경쟁 상태 관리의 중요성
- 경쟁 상태를 잘 해결하지 못하면 다음과 같은 사례가 발생한다.

#### 데이터 정합성
- 예상되는 데이터의 값과 다른 상황이다.
> 읽을 때 0원이어야 하는데 1000원인 것

#### 데이터 무결성
- 데이터의 어떠한 규칙을 위반하면 안되는 것을 말한다.
> 은행에서 0원인데 출금하는 것






